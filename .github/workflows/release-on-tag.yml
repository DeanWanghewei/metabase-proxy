name: Create Release on Tag

on:
    push:
        tags:
            - "v*" # åŒ¹é…ä»¥ v å¼€å¤´çš„ tagï¼Œå¦‚ v1.0, v2.1 ç­‰

jobs:
    create-release:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            packages: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v4

            - name: Make gradlew executable
              run: chmod +x ./gradlew

            - name: Build plugin
              run: ./gradlew buildPlugin

            - name: Extract tag name
              id: tag
              run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

            - name: Get plugin artifact path
              id: plugin_path
              run: |
                  PLUGIN_FILE=$(find build/distributions -name "*.zip" | head -1)
                  echo "PLUGIN_FILE=$PLUGIN_FILE" >> $GITHUB_OUTPUT
                  echo "PLUGIN_NAME=$(basename $PLUGIN_FILE)" >> $GITHUB_OUTPUT

            - name: Generate release notes
              id: release_notes
              run: |
                  cat > release_notes.md << 'EOF'
                  ðŸš€ **Metabase Proxy Plugin Release ${{ steps.tag.outputs.TAG_NAME }}**

                  ## ðŸ“¦ ä¸‹è½½
                  ä¸‹è½½ä¸‹æ–¹çš„æ’ä»¶åŒ…æ–‡ä»¶ï¼Œåœ¨ IntelliJ IDEA ä¸­å®‰è£…å³å¯ä½¿ç”¨ã€‚

                  ## ðŸ“‹ å®‰è£…æ–¹æ³•
                  1. ä¸‹è½½ `.zip` æ–‡ä»¶
                  2. æ‰“å¼€ IntelliJ IDEA
                  3. è¿›å…¥ `File` â†’ `Settings` â†’ `Plugins`
                  4. ç‚¹å‡»é½¿è½®å›¾æ ‡ â†’ `Install Plugin from Disk...`
                  5. é€‰æ‹©ä¸‹è½½çš„ `.zip` æ–‡ä»¶
                  6. é‡å¯ IDE

                  ## âœ¨ ä½¿ç”¨æ–¹æ³•
                  1. åœ¨ Settings ä¸­å¡«å†™ Metabase åœ°å€å’Œç”¨æˆ·ä¿¡æ¯
                  2. é€‰ä¸­è¦æ‰§è¡Œçš„ SQLï¼Œå³é”®é€‰æ‹© "Run Metabase Query"
                  3. æˆ–ä½¿ç”¨å¿«æ·é”®æ‰§è¡ŒæŸ¥è¯¢

                  ---
                  *è‡ªåŠ¨æž„å»ºæ—¶é—´: $(date -u)*
                  EOF

            - name: Create Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.tag.outputs.TAG_NAME }}
                  name: Release ${{ steps.tag.outputs.TAG_NAME }}
                  body_path: release_notes.md
                  files: ${{ steps.plugin_path.outputs.PLUGIN_FILE }}
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
